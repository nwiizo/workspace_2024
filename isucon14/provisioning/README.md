# AMIをビルドするスクリプト

# 手動でのビルド手順

AMIイメージは

- 各言語の実行環境を含むベースイメージ
- アプリケーションコードを含む競技イメージ

の2つに別れています。

競技イメージはベースイメージをソースにビルドを実行するため、作成するAWS環境にベースイメージが存在しない場合、必ず一度ベースイメージの作成を実行する必要があります。  
実行環境に修正を加えた場合も手動で再度ベースイメージのビルドが必要になります。  
(所要時間20分程度かかる可能性があります)

ベースイメージを作成後、アプリケーションコードの変更のみ反映したい場合は競技イメージのビルドのみを行うことが出来ます。

```
# AMIを作成するAWS環境にログイン
aws --profile ${aws_env} sso login

# ビルド実行(ベースイメージ)
cd provisioning/packer
make base-build

# ビルド実行(アプリケーション)
cd provisioning/packer
make
```

## 前提条件

以下のものがインストールされていること
- packer
- go-task (バックエンドのビルドのため)
- pnpm (フロントのビルドのため)

# 留意事項

- CIは動作未確認のためまだ動かないようにしてあります
- 作問合宿用の暫定として `trial.isucon14.net` の自己証明書を含んでいます

## フロントエンド
`frontend/Makefile` に依存
`pnpm run build` した結果の `build/client` 以下のファイルをnginxのディレクトリにデプロイしています

## API
現時点で `/api`, `/app`, `/provider`, `/chair` 宛のリクエストが 8080にproxyされるようにnginxが構成されています
エンドポイントの増減がある場合はnginxの設定ファイルの修正が必要です

APIサーバの動作に必要な環境変数は `provisioning/ansible/roles/isucon-user/templates/env.sh` で定義しています

## DB
初期化処理として `webapp/sql/init.sh` を流しています
初期化したい処理が追加になった場合は修正が必要です
